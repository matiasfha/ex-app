/**!
 * FileAPI â€” a set of tools for working with files
 *
 * @author  RubaXa  <trash@rubaxa.org>
 * @build	lib/canvas-to-blob lib/FileAPI.core lib/FileAPI.Image lib/FileAPI.Form lib/FileAPI.XHR lib/FileAPI.Flash
 */
(function(e){var t=e.HTMLCanvasElement&&e.HTMLCanvasElement.prototype,n;if(n=e.Blob)try{n=Boolean(new Blob)}catch(r){n=!1}var i=n;if(n=i)if(n=e.Uint8Array)try{n=100===(new Blob([new Uint8Array(100)])).size}catch(s){n=!1}var o=n,u=e.BlobBuilder||e.WebKitBlobBuilder||e.MozBlobBuilder||e.MSBlobBuilder,a=(i||u)&&e.atob&&e.ArrayBuffer&&e.Uint8Array&&function(e){var t,n,r,s;t=0<=e.split(",")[0].indexOf("base64")?atob(e.split(",")[1]):decodeURIComponent(e.split(",")[1]),n=new ArrayBuffer(t.length),r=new Uint8Array(n);for(s=0;s<t.length;s+=1)r[s]=t.charCodeAt(s);return e=e.split(",")[0].split(":")[1].split(";")[0],i?new Blob([o?r:n],{type:e}):(r=new u,r.append(n),r.getBlob(e))};e.HTMLCanvasElement&&!t.toBlob&&(t.mozGetAsFile?t.toBlob=function(e,t){e(this.mozGetAsFile("blob",t))}:t.toDataURL&&a&&(t.toBlob=function(e,t){e(a(this.toDataURL(t)))})),"function"==typeof define&&define.amd?define(function(){return a}):e.dataURLtoBlob=a})(this),function(e,t){function n(e,t,n){if(e)if(l(e))for(var r=0,i=e.length;r<i;r++)r in e&&t.call(n,e[r],r,e);else for(r in e)e.hasOwnProperty(r)&&t.call(n,e[r],r,e)}function r(e,t,r){if(e){var i=_.uid(e);L[i]||(L[i]={}),n(t.split(/\s+/),function(t){g?g.event.add(e,t,r):(L[i][t]||(L[i][t]=[]),L[i][t].push(r),e.addEventListener?e.addEventListener(t,r,!1):e.attachEvent?e.attachEvent("on"+t,r):e["on"+t]=r)})}}function i(e,t,r){if(e){var i=_.uid(e),s=L[i]||{};n(t.split(/\s+/),function(t){if(g)g.event.remove(e,t,r);else{for(var n=s[t]||[],i=n.length;i--;)if(n[i]===r){n.splice(i,1);break}e.addEventListener?e.removeEventListener(t,r,!1):e.detachEvent?e.detachEvent("on"+t,r):e["on"+t]=null}})}}function s(e,t,n){r(e,t,function s(r){i(e,t,s),n(r)})}function o(e,t,n,r,i){e={type:n.type||n,target:e,result:r},_.extend(e,i),t(e)}function u(e,n,s,u){if(_.isFile(e)&&v&&v.prototype["readAs"+s]){var a=new v;r(a,O,function l(t){var r=t.type;"progress"==r?o(e,n,t,t.target.result,{loaded:t.loaded,total:t.total}):"loadend"==r?(i(a,O,l),a=null):o(e,n,t,t.target.result)});try{u?a["readAs"+s](u,e):a["readAs"+s](e)}catch(f){o(e,n,"error",t,{error:f.toString()})}}else o(e,n,"error",t,{error:"filreader_not_support_"+s})}function a(e){var t;return e.getAsEntry?t=e.getAsEntry():e.webkitGetAsEntry&&(t=e.webkitGetAsEntry()),t}function f(e,t){if(e)if(e.isFile)e.file(function(e){t(!1,[e])},function(){t("entry_file")});else if(e.isDirectory){var n=[];e.createReader().readEntries(function(e){_.afor(e,function(e,r){f(r,function(r,i){r||(n=n.concat(i)),e?e():t(!1,n)})})},function(){t("directory_reader")})}else f(a(e),t);else t("empty_entry")}function l(e){return"object"==typeof e&&e&&"length"in e}function c(t){return t.target||(t.target=e.event&&e.event.srcElement||b),3===t.target.nodeType&&(t.target=event.target.parentNode),t}var h=1,p=e.createObjectURL&&e||e.URL&&URL.revokeObjectURL&&URL||e.webkitURL&&webkitURL,d=e.File,v=e.FileReader,m=e.FormData,g=e.jQuery,y=!!d&&!!(v&&e.Uint8Array||m),m=y&&"withCredentials"in new XMLHttpRequest,b=e.document,w=e.dataURLtoBlob,E={},S=/img/i,x=/canvas/i,T=/img|canvas/,N=/input/i,C=/^data:[^,]+,/,k=Math.pow,L={},A=[],O="abort progress error load loadend",M="status statusText readyState response responseXML responseText responseBody".split(" "),_={build:4,cors:!1,debug:!1,pingUrl:!1,staticPath:"./",KB:1024,MB:k(1024,2),GB:k(1024,3),TB:k(1024,4),expando:"fileapi"+ +(new Date),uid:function(e){return e?e[_.expando]=e[_.expando]||_.uid():_.expando+ ++h},log:function(){_.debug&&e.console&&console.log&&(console.log.apply?console.log.apply(console,arguments):console.log([].join.call(arguments," ")))},getXHR:function(){var t;if(e.XMLHttpRequest)t=new XMLHttpRequest;else if(e.ActiveXObject)try{t=new ActiveXObject("MSXML2.XMLHttp.3.0")}catch(n){}return t},isArray:l,support:{dnd:m&&"ondrop"in b.createElement("div"),cors:m,html5:y,dataURI:!0},event:{on:r,off:i,one:s,fix:c},throttle:function(t,n){var r,i;return function(){i=arguments,r||(t.apply(e,i),r=setTimeout(function(){r=0,t.apply(e,i)},n))}},F:function(){},parseJSON:function(t){return e.JSON&&JSON.parse?JSON.parse(t):(new Function("return ("+t.replace(/([\r\n])/g,"\\$1")+");"))()},trim:function(e){return e=String(e),e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")},queue:function(e){var t=0,n=0,r=!1,i=!1,s={inc:function(){n++},next:function(){t++,setTimeout(s.check,0)},check:function(){t>=n&&!r&&s.end()},isFail:function(){return r},fail:function(){!r&&e(r=!0)},end:function(){i||(i=!0,e())}};return s},each:n,afor:function(e,t){var n=0,r=e.length;l(e)&&r--?function i(){t(r!=n&&i,e[n],n++)}():t(!1)},extend:function(e){return n(arguments,function(t){n(t,function(t,n){e[n]=t})}),e},isFile:function(e){return y&&e&&e instanceof d},isCanvas:function(e){return e&&x.test(e.nodeName)},getFilesFilter:function(e){return(e="string"==typeof e?e:e.getAttribute&&e.getAttribute("accept")||"")?RegExp("("+e.replace(/\./g,"\\.").replace(/,/g,"|")+")$","i"):/./},readAsDataURL:function(e,t){_.isCanvas(e)?o(e,t,"load",_.toDataURL(e)):u(e,t,"DataURL")},readAsBinaryString:function(e,t){v&&v.prototype.readAsBinaryString?u(e,t,"BinaryString"):u(e,function(e){if("load"==e.type)try{e.result=_.toBinaryString(e.result)}catch(n){e.type="error",e.message=n.toString()}t(e)},"DataURL")},readAsArrayBuffer:function(e,t){u(e,t,"ArrayBuffer")},readAsText:function(e,t,n){n||(n=t,t="utf-8"),u(e,n,"Text",t)},toDataURL:function(e){if("string"==typeof e)return e;if(e.toDataURL)return e.toDataURL("image/png")},toBinaryString:function(t){return e.atob(_.toDataURL(t).replace(C,""))},readAsImage:function(e,n,r){if(_.isFile(e))if(p){var u=p.createObjectURL(e);u===t?o(e,n,"error"):_.readAsImage(u,n,r)}else _.readAsDataURL(e,function(t){"load"==t.type?_.readAsImage(t.result,n,r):(r||"error"==t.type)&&o(e,n,t,null,{loaded:t.loaded,total:t.total})});else _.isCanvas(e)?o(e,n,"load",e):S.test(e.nodeName)?e.complete?o(e,n,"load",e):s(e,"error abort load",function a(t){"load"==t.type&&p&&p.revokeObjectURL(e.src),i(e,"error abort load",a),o(e,n,t,e)}):e.iframe?o(e,n,{type:"error"}):(u=new Image,u.src=e.dataURL||e,_.readAsImage(u,n,r))},checkFileObj:function(e){var r={};return"object"==typeof e?r=e:r.name=(e+"").split(/(\\|\/)/g).pop(),r.type===t&&(r.type=r.name.split(".").pop()),n(E,function(e,t){e.test(r.type)&&(r.type=t+"/"+r.type)}),r},getDropFiles:function(e,t){var r=[],i=(e.originalEvent||e||"").dataTransfer||{},o=l(i.items)&&i.items[0]&&a(i.items[0]),u=_.queue(function(){t(r)});n((o?i.items:i.files)||[],function(e){u.inc();if(o)f(e,function(e,t){!e&&r.push.apply(r,t),u.next()});else{var t=function(t){t&&r.push(e),u.next()};if(!e.type&&0==e.size%4096&&102400>=e.size)if(v)try{var n=new v;s(n,O,function(e){e="error"!=e.type,t(e),e&&n.abort()}),n.readAsDataURL(e)}catch(i){t(!1)}else t(null);else t(!0)}}),u.check()},getFiles:function(e,t,n){var r=[];return n?(_.filterFiles(_.getFiles(e),t,n),null):(e.jquery&&(e.each(function(){r=r.concat(_.getFiles(this))}),e=r,r=[]),"string"==typeof t&&(t=_.getFilesFilter(t)),e.originalEvent&&(e=c(e.originalEvent)),e.dataTransfer?e=e.dataTransfer:e.target&&(e=e.target),e.files?r=e.files:!y&&N.test(e&&e.tagName)?_.trim(e.value)&&(r=[_.checkFileObj(e.value)],r[0].blob=e,r[0].iframe=!0):l(e)&&(r=e),!t&&N.test(e&&e.tagName)&&(t=_.getFilesFilter(e)),_.filter(r,function(e){return!t||t.test(e.name)}))},getInfo:function(e,t){var n={},r=A.concat();_.isFile(e)?function i(){var s=r.shift();s?s.test(e.type)?s(e,function(e,r){e?t(e):(_.extend(n,r),i())}):i():t(!1,n)}():t("not_support",n)},addInfoReader:function(e,t){t.test=function(t){return e.test(t)},A.push(t)},addMime:function(e,t){E[e]=RegExp("("+t.replace(/,/g,"|")+")$","i")},filter:function(e,t){for(var n=[],r=0,i=e.length,s;r<i;r++)r in e&&(s=e[r],t.call(s,s,r,e)&&n.push(s));return n},filterFiles:function(e,t,n){if(e.length){var r=e.concat(),i,s=[],o=[];(function u(){r.length?(i=r.shift(),_.getInfo(i,function(e,n){(t(i,e?!1:n)?s:o).push(i),u()})):n(s,o)})()}else n([],e)},upload:function(e){var e=_.extend({beforeupload:_.F,upload:_.F,fileupload:_.F,fileprogress:_.F,filecomplete:_.F,progress:_.F,complete:_.F},e),t=new _.XHR(e),r=this._getFilesDataArray(e.files),i=0,s=0,o=0,u=1;return n(r,function(e){i+=e.size}),t.total=i,t.loaded=0,e.beforeupload(t,e),function a(){var f=r.shift(),l=this;t.currentFile=f,"abort"!=t.statusText&&f?this._getFormData(e,f,function(r){s||e.upload(t,e);var c=f.file,h=new _.XHR(_.extend({},e,{upload:function(){e.fileupload(c,h,e)},progress:function(n){n.lengthComputable&&(o=s+=~~(i*u*(n.loaded/n.total)-o+.5),e.fileprogress(n,c,h,e),e.progress({type:n.type,total:i,loaded:t.loaded=s,lengthComputable:!0},c,h,e))},complete:function(r){n(M,function(e){t[e]=h[e]}),t.loaded=s+=s-o+~~(i*u+.5),e.filecomplete(r,h,c,e),a.call(l)}}));u=f.size/i,t.abort=function(){h.abort()},h.send(r)}):e.complete(200==t.status?!1:t.statusText||"error",t,e)}.call(this),t},_getFilesDataArray:function(e){var t=[],r={};if(N.test(e&&e.tagName)){var i=_.getFiles(e);r[e.name||"file"]=null!==e.getAttribute("multiple")?i:i[0]}else l(e)&&N.test(e[0]&&e[0].tagName)?n(e,function(e){r[e.name||"file"]=_.getFiles(e)}):r=e;return n(r,function s(e,r){l(e)?n(e,function(e,t){s(e,r+"["+t+"]")}):e&&e.name&&t.push({name:r,file:e,size:e.size})}),t},_getFormData:function(e,t,r){var i=t.file,s=t.name,o=i.name,u=i.type,a=(t=_.support.transform&&e.imageTransform)&&"number"==typeof (t.maxWidth||t.minWidth||t.width),f=new _.Form,l=_.queue(function(){r(f)});t&&(/image/.test(i.type)||T.test(i.nodeType))?(l.inc(),a&&(t=[t]),_.Image.transform(i,t,function(t,r){a&&!t?(!w&&!_.flashEngine&&(r[0]=_.toBinaryString(r[0]),f.multipart=!0),f.append(s,r[0],o,u)):(t||(n(r,function(e,t){!w&&!_.flashEngine&&(e=_.toBinaryString(e),f.multipart=!0),f.append(s+"["+t+"]",e,o,u)}),s+="[original]"),(t||e.imageOriginal)&&f.append(s,i,o,u)),l.next()})):f.append(s,i,o),n(e.data,function c(e,t){"object"==typeof e?n(e,function(e,n){c(e,t+"["+n+"]")}):f.append(t,e)}),l.check()},reset:function(e){var t,s;return g?(s=g(e).clone(!0).insertBefore(e).val("")[0],g(e).remove()):(t=e.parentNode,s=t.insertBefore(e.cloneNode(!0),e),s.value="",t.removeChild(e),n(L[_.uid(e)],function(t,o){n(t,function(t){i(e,o,t),r(s,o,t)})})),s},load:function(e,t){var n=_.getXHR();return n?(n.open("GET",e,!0),n.overrideMimeType&&n.overrideMimeType("text/plain; charset=x-user-defined"),r(n,"progress",function(e){e.lengthComputable&&t({type:e.type,loaded:e.loaded,total:e.total},n)}),n.onreadystatechange=function(){if(4==n.readyState)if(n.onreadystatechange=null,200==n.status){e=e.split("/");var r={name:e[e.length-1],size:n.getResponseHeader("Content-Length"),type:n.getResponseHeader("Content-Type")};r.dataURL="data:"+r.type+";base64,"+_.encode64(n.responseBody||n.responseText),t({type:"load",result:r})}else t({type:"error"})},n.send(null)):t({type:"error"}),n},encode64:function(e){var t="",n=0;for("string"!=typeof e&&(e=String(e));n<e.length;){var r=e.charCodeAt(n++)&255,i=e.charCodeAt(n++)&255,s=e.charCodeAt(n++)&255,o=r>>2,r=(r&3)<<4|i>>4;isNaN(i)?i=s=64:(i=(i&15)<<2|s>>6,s=isNaN(s)?64:s&63),t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(o)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(r)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(i)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(s)}return t}};n({image:"png,jpg,jpeg,bmp,gif,ico,tif,tiff,tga,pcx,cbz,cbr",audio:"m4a,flac,aac,rm,mpa,wav,wma,ogg,mp3,mp2,m3u,mod,amf,dmf,dsm,far,gdm,imf,it,m15,med,okt,s3m,stm,sfx,ult,uni,xm,sid,ac3,dts,cue,aif,aiff,wpl,ape,mac,mpc,mpp,shn,wv,nsf,spc,gym,adplug,adx,dsp,adp,ymf,ast,afc,hps,xsp",video:"m4v,3gp,nsv,ts,ty,strm,rm,rmvb,m3u,ifo,mov,qt,divx,xvid,bivx,vob,nrg,img,iso,pva,wmv,asf,asx,ogm,m2v,avi,bin,dat,dvr-ms,mpg,mpeg,mp4,mkv,avc,vp3,svq3,nuv,viv,dv,fli,flv,wpl"},function(e,t){_.addMime(t,e)}),_.addInfoReader(/^image/,function(e,t){_.readAsImage(e,function(e){var n=e.target;t("load"==e.type?!1:"error",{width:n.width,height:n.height})})}),_.event.dnd=function(e,t,n){var i,s;n||(n=t,t=_.F),v?(r(e,"dragenter dragleave dragover",function(e){for(var n=((e.originalEvent||e||"").dataTransfer||{}).types,r=n&&n.length;r--;)~n[r].indexOf("File")&&(e.preventDefault(),s!==e.type&&(s=e.type,"dragleave"!=s&&t.call(e.currentTarget,!0,e),clearTimeout(i),i=setTimeout(function(){t.call(e.currentTarget,"dragleave"!=s,e)},50)))}),r(e,"drop",function(e){e.preventDefault(),s=0,t.call(e.currentTarget,!1,e),_.getDropFiles(e,function(t){n.call(e.currentTarget,t,e)})})):_.log("Drag'n'Drop -- not supported")},g&&!g.fn.dnd&&(g.fn.dnd=function(e,t){return this.each(function(){_.event.dnd(this,e,t)})}),e.FileAPI=_.extend(_,e.FileAPI)}(window),function(e,t,n){function r(e,t){if(!(this instanceof r))return new r(e);this.data=e,this.better=!t,this.matrix={sx:0,sy:0,sw:0,sh:0,dx:0,dy:0,dw:0,dh:0,resize:0,deg:0}}var i=Math.min,s=Math.round,o=!1;try{o=-1<t.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")}catch(u){}r.prototype={constructor:r,set:function(t){return e.extend(this.matrix,t),this},crop:function(e,t,r,i){return r===n&&(r=e,i=t,e=t=0),this.set({sx:e,sy:t,sw:r,sh:i||r})},resize:function(e,t,n){return"string"==typeof t&&(n=t,t=e),this.set({dw:e,dh:t,resize:n})},preview:function(e,t){return this.set({dw:e,dh:t||e,resize:"preview"})},rotate:function(e){return this.set({deg:e})},_load:function(t,n){var r=this;e.readAsImage(t,function(e){n.call(r,"load"!=e.type,e.result)})},_apply:function(e,n){var r=t.createElement("canvas"),i=this.getMatrix(e),s=r.getContext("2d"),o=i.deg,u=i.dw,a=i.dh,f=e.width,l=e.height,c,h=e;if(this.better)for(;2<Math.min(f/u,l/a);)f=~~(f/2+.5),l=~~(l/2+.5),c=t.createElement("canvas"),c.width=f,c.height=l,h!==e?(c.getContext("2d").drawImage(h,0,0,h.width,h.height,0,0,f,l),h=c):(h=c,h.getContext("2d").drawImage(e,i.sx,i.sy,i.sw,i.sh,0,0,f,l),i.sx=i.sy=i.sw=i.sh=0);r.width=o%180?a:u,r.height=o%180?u:a,s.rotate(o*Math.PI/180),s.drawImage(h,i.sx,i.sy,i.sw||h.width,i.sh||h.height,180==o||270==o?-u:0,90==o||180==o?-a:0,u,a),n.call(this,!1,r)},getMatrix:function(t){var n=e.extend({},this.matrix),r=n.sw=n.sw||t.width,t=n.sh=n.sh||t.height,o=n.dw=n.dw||n.sw,u=n.dh=n.dh||n.sh,l=r/t,c=o/u,h=n.resize;if("preview"==h){if(o!=r||u!=t)if(c>=l?(l=r,h=l/c):(h=t,l=h*c),l!=r||h!=t)n.sx=~~((r-l)/2),n.sy=~~((t-h)/2),r=l,t=h}else h&&("min"==h?(o=s(l<c?i(r,o):u*l),u=s(l<c?o/l:i(t,u))):(o=s(l>=c?i(r,o):u*l),u=s(l>=c?o/l:i(t,u))));return n.sw=r,n.sh=t,n.dw=o,n.dh=u,n},get:function(t){e.support.transform?this._load(this.data,function(e,n){e?t(e):this._apply(n,t)}):t("not_support")},toData:function(e){this.get(e)}},r.transform=function(t,n,i){e.getInfo(t,function(s,o){var u={},l=e.queue(function(e){i(e,u)});s?l.fail():e.each(n,function(e,n){if(!l.isFail()){var i=r(o.nodeType?o:t);"function"==typeof e?e(o,i):e.width?i[e.preview?"preview":"resize"](e.width,e.height,e.type):(e.maxWidth&&(o.width>e.maxWidth||o.height>e.maxHeight)&&i.resize(e.maxWidth,e.maxHeight,"max"),i.rotate(~~e.rotate)),l.inc(),i.toData(function(e,t){e?l.fail():(u[n]=t,l.next())})}})})},e.support.canvas=e.support.transform=o,e.Image=r}(FileAPI,document),function(e,t,n){var r=t.encodeURIComponent,i=t.FormData,t=function(){this.items=[]};t.prototype={append:function(e,t,n,r){this.items.push({name:e,blob:t&&t.blob||t,file:n||t.name,type:r||t.type})},each:function(e){for(var t=0,n=this.items.length;t<n;t++)e.call(this,this.items[t])},toData:function(t){e.support.html5?this.multipart?(e.log("FileAPI.Form.toMultipartData"),this.toMultipartData(t)):(e.log("FileAPI.Form.toFormData"),this.toFormData(t)):(e.log("tFileAPI.Form.toHtmlData"),this.toHtmlData(t))},_to:function(t,n,r,i){var s=e.queue(function(){n(t)});this.each(function(e){r(e,t,s,i)}),s.check()},toHtmlData:function(t){this._to(n.createDocumentFragment(),t,function(t,r){var i=t.blob,s;t.file?(e.reset(i),i.name=t.name,r.appendChild(i)):(s=n.createElement("input"),s.name=t.name,s.type="hidden",s.value=i,r.appendChild(s))})},toFormData:function(e){this._to(new i,e,function(e,t,n){e.file&&t.append("_"+e.name,e.file),e.blob.toBlob?(n.inc(),e.blob.toBlob(function(r){t.append(e.name,r,e.file),n.next()},"image/png")):e.file?t.append(e.name,e.blob,e.file):t.append(e.name,e.blob)})},toMultipartData:function(t){this._to([],t,function(e,t,n,i){t.push("--_"+i+('\r\nContent-Disposition: form-data; name="'+e.name+'"'+(e.file?'; filename="'+r(e.file)+'"':"")+(e.file?"\r\nContent-Type: "+(e.type||"application/octet-stream"):"")+"\r\n\r\n"+(e.file?e.blob:r(e.blob))+"\r\n"))},e.expando)}},e.Form=t}(FileAPI,window,document),function(e,t){var n=function(){},r=function(e){this.uid=t.uid(),this.xhr={abort:n,getResponseHeader:n,getAllResponseHeaders:n},this.options=e};r.prototype={status:0,statusText:"",getResponseHeader:function(e){return this.xhr.getResponseHeader(e)},getAllResponseHeaders:function(){return this.xhr.getAllResponseHeaders()||{}},end:function(r,i){var s=this,o=s.options;s.end=s.abort=n,s.status=r,i&&(s.statusText=i),t.log("xhr.end:",r,i),o.complete(200==r?!1:s.statusText||"unknown",s),s.xhr&&s.xhr.node&&setTimeout(function(){var t=s.xhr.node;try{t.parentNode.removeChild(t)}catch(n){}try{delete e[s.uid]}catch(r){}e[s.uid]=s.xhr.node=null},9)},abort:function(){this.end(0,"abort"),this.xhr&&this.xhr.abort()},send:function(e){var t=this,n=this.options;e.toData(function(e){n.upload(n,t),t._send.call(t,n,e)})},_send:function(n,r){var i=this,s,o=i.uid;t.log("XHR._send:",r);if(r.nodeName){n.upload(n,i),s=document.createElement("div"),s.innerHTML='<form target="'+o+'" action="'+n.url+'" method="POST" enctype="multipart/form-data" style="position: absolute; top: -1000px; overflow: hidden; width: 1px; height: 1px;"><iframe name="'+o+'" src="javascript:false;"></iframe><input value="'+o+'" name="callback" type="hidden"/></form>',i.xhr.abort=function(){var e=s.getElementsByName("iframe")[0];if(e)try{e.stop?e.stop():e.contentWindow.stop?e.contentWindow.stop():e.contentWindow.document.execCommand("Stop")}catch(t){}s=null};var u=s.getElementsByTagName("form")[0];u.appendChild(r),t.log(u.parentNode.innerHTML),document.body.appendChild(s),i.xhr.node=s,e[o]=function(e,t,n){i.readyState=4,i.responseText=n,i.end(e,t),s=null},i.readyState=2,u.submit(),u=null}else s=i.xhr=t.getXHR(),s.open("POST",n.url,!0),s.withCredential="true",(!n.headers||!n.headers["X-Requested-With"])&&s.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.each(n.headers,function(e,t){s.setRequestHeader(t,e)}),s.upload&&s.upload.addEventListener("progress",t.throttle(function(e){n.progress(e,i,n)},100),!1),s.onreadystatechange=function(){i.status=s.status,i.statusText=s.statusText,i.readyState=s.readyState;if(4==s.readyState){for(var e in{"":1,XML:1,Text:1,Body:1})i["response"+e]=s["response"+e];s.onreadystatechange=null,i.end(s.status),s=null}},t.isArray(r)?(s.setRequestHeader("Content-Type","multipart/form-data; boundary=_"+t.expando),r=r.join("")+"--_"+t.expando+"--",s.sendAsBinary?s.sendAsBinary(r):(o=Array.prototype.map.call(r,function(e){return e.charCodeAt(0)&255}),s.send((new Uint8Array(o)).buffer))):s.send(r)}},t.XHR=r}(window,FileAPI),function(e,t,n){var r=e.support,i=t.navigator,s=i.mimeTypes,o=!1;if(i.plugins&&"object"==typeof i.plugins["Shockwave Flash"])o=i.plugins["Shockwave Flash"].description&&!(s&&s["application/x-shockwave-flash"]&&!s["application/x-shockwave-flash"].enabledPlugin);else try{o=!!t.ActiveXObject&&!!(new ActiveXObject("ShockwaveFlash.ShockwaveFlash"))}catch(u){}r.flash=o;if(e.support.flash&&(!e.support.html5||e.cors&&!e.support.cors)){var a=function(e){return'<object id="#id#" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="100%" height="100%"><param name="movie" value="#src#" /><param name="flashvars" value="#flashvars#" /><param name="swliveconnect" value="true" /><param name="allowscriptaccess" value="always" /><param name="allownetworking" value="all" /><param name="menu" value="false" /><param name="wmode" value="#wmode#" /><embed flashvars="#flashvars#" swliveconnect="true" allownetworking="all" allowscriptaccess="always" name="#id#" src="#src#"  width="100%" height="100%" menu="false" wmode="transparent" type="application/x-shockwave-flash"></embed></object>'.replace(/#(\w+)#/ig,function(t,n){return e[n]})},f=function(e,t){if(e&&e.style){var n,r;for(n in t){r=t[n],"number"==typeof r&&(r+="px");try{e.style[n]=r}catch(i){}}}},l=function(t,n){e.each(n,function(e,n){var r=t[n];t[n]=function(){return this.parent=r,e.apply(this,arguments)}})},c=function(t){var n=t.wid=e.uid();return y._fn[n]=t,"FileAPI.Flash._fn."+n},h=function(e){try{y._fn[e.wid]=null,delete y._fn[e.wid]}catch(t){}},p=function(e){if(!g.test(e)){if(/^\.\//.test(e)||"/"!=e.charAt(0))var t=location.pathname,t=t.substr(0,t.lastIndexOf("/")),e=t+"/"+e.substr("./"==RegExp.$1?2:0);"//"!=e.substr(0,2)&&(e=location.hostname+"/"+e),g.test(e)||(e=location.protocol+"//"+e)}return e},d=e.uid(),v=0,m={},g=/^https?:/i,y={_fn:{},init:function(){var t=n.body&&n.body.firstChild;if(t)do if(1==t.nodeType){e.log("FlashAPI.Flash.inited");var r=n.createElement("div");f(r,{top:1,right:1,width:5,height:5,position:"absolute"}),t.parentNode.insertBefore(r,t),y.publish(r,d);return}while(t=t.nextSibling);10>v&&setTimeout(y.init,50*++v)},publish:function(t,n){t.innerHTML=a({id:n,src:p(e.staticPath+"FileAPI.flash.swf?r="+e.build),wmode:"transparent",flashvars:"callback=FileAPI.Flash.event&flashId="+n+"&storeKey="+navigator.userAgent.match(/\d/ig).join("")+"_"+e.build+(y.isReady||(e.pingUrl?"&ping="+e.pingUrl:""))})},ready:function(){y.ready=e.F,y.isReady=!0,y.patch(),e.event.on(n,"mouseover",y.mouseover),e.event.on(n,"click",function(e){y.mouseover(e)&&(e.preventDefault?e.preventDefault():e.returnValue=!0)})},getWrapper:function(e){do if(/js-fileapi-wrapper/.test(e.className))return e;while((e=e.parentNode)&&e!==n.body)},mouseover:function(t){t=e.event.fix(t).target;if(/input/i.test(t.nodeName)&&"file"==t.type){var r=t.getAttribute(d);if("i"==r||"r"==r)return!1;if("p"!=r){t.setAttribute(d,"i");var r=n.createElement("div"),i=y.getWrapper(t);if(!i){e.log("flash.mouseover.error: js-fileapi-wrapper not found");return}f(r,{top:0,left:0,width:t.offsetWidth+100,height:t.offsetHeight+100,zIndex:"1000000",position:"absolute"}),i.appendChild(r),y.publish(r,e.uid()),t.setAttribute(d,"p")}return!0}},event:function(t){var n=t.type;if("ready"==n){try{y.getInput(t.flashId).setAttribute(d,"r")}catch(r){}return y.ready(),setTimeout(function(){y.mouseenter(t)},50),!0}"ping"===n?e.log("(flash -> js).ping:",[t.status,t.savedStatus],t.error):"log"===n?e.log("(flash -> js).log:",t.target):n in y&&setTimeout(function(){e.log("Flash.event."+t.type+":",t),y[n](t)},1)},mouseenter:function(e){var t=y.getInput(e.flashId);t&&(y.cmd(e,"multiple",null!==t.getAttribute("multiple")),y.cmd(e,"accept",(t.getAttribute("accept")||"*").replace(/\./g,"")))},get:function(e){return n[e]||t[e]||n.embeds[e]},getInput:function(e){try{var t=y.getWrapper(y.get(e));if(t)return t.getElementsByTagName("input")[0]}catch(n){}},select:function(t){var r=y.getInput(t.flashId),i=e.uid(r),t=t.target.files;e.each(t,function(t){e.checkFileObj(t)}),m[i]=t,n.createEvent?(i=n.createEvent("Event"),i.initEvent("change",!0,!1),r.dispatchEvent(i)):n.createEventObject&&(i=n.createEventObject(),r.fireEvent("onchange",i))},cmd:function(t,n,r,i){try{return e.log("(js -> flash)."+n+":",r),y.get(t.flashId||t).cmd(n,r)}catch(s){e.log("(js -> flash).onError:",s),i||setTimeout(function(){y.cmd(t,n,r,!0)},50)}},patch:function(){e.flashEngine=e.support.transform=!0,l(e,{getFiles:function(t,n,r){if(r)return e.filterFiles(e.getFiles(t),n,r),null;var i=e.isArray(t)?t:m[e.uid(t.target||t.srcElement||t)];return i?(n&&(n=e.getFilesFilter(n),i=e.filter(i,function(e){return n.test(e.name)})),i):this.parent.apply(this,arguments)},getInfo:function(e,t){e&&!e.flashId?this.parent.apply(this,arguments):e.info?t(!1,e.info):y.cmd(e,"getFileInfo",{id:e.id,callback:c(function n(r,i){h(n),t(r,e.info=i)})})}}),e.support.transform=!0,l(FileAPI.Image.prototype,{_load:function(t,n){e.log("FileAPI.Image._load:",t);if(t&&!t.flashId)this.parent.apply(this,arguments);else{var r=this;e.getInfo(t,function(e){n.call(r,e,t)})}},_apply:function(t,r){e.log("FileAPI.Image._apply:",t);if(t&&!t.flashId)this.parent.apply(this,arguments);else{var i=this.getMatrix(t.info);y.cmd(t,"imageTransform",{id:t.id,matrix:i,callback:c(function s(o,u){e.log("FileAPI.Image._apply.callback:",o),h(s);if(o)r(o);else if(!e.support.dataURI||3e4<u.length){var l={width:i.deg%180?i.dh:i.dw,height:i.deg%180?i.dw:i.dh},p=r,d=function(){try{y.get(m).setImage(u)}catch(e){}},v,m=e.uid(),g=n.createElement("div");for(v in l)g.setAttribute("data-img-"+v,l[v]);f(g,l),e.log("flash.image.publish"),g.innerHTML=a({id:m,src:e.staticPath+"FileAPI.flash.image.swf?r="+e.uid(),wmode:"opaque",flashvars:"scale=noScale&callback="+c(function w(){return h(w),setTimeout(d,99),!0})}),p(!1,g),g=null}else{var b=new Image;e.event.one(b,"error abort load",function(e){r("load"!=e.type&&e.type,b),b=null}),b.src="data:"+t.type+";base64,"+u}})})}},toData:function(e){var t=this.data;t&&!t.flashId?this.parent.apply(this,arguments):e.call(this,!t.info,{id:t.id,flashId:t.flashId,name:t.name,type:t.type,matrix:this.getMatrix(t.info)})}}),l(e.Form.prototype,{toData:function(t){for(var n=this.items,r=n.length;r--;)if(n[r].file&&n[r].blob&&!n[r].blob.flashId)return this.parent.apply(this,arguments);e.log("flash.Form.toData"),t(n)}}),l(e.XHR.prototype,{_send:function(t,n){if(n.nodeName||n.append&&e.support.html5||e.isArray(n)&&"string"==typeof n[0])return this.parent.apply(this,arguments);var r={},i={},s=this,o,u;e.each(n,function(e){e.file?(i[e.name]=e=e.blob,u=e.id,o=e.flashId):r[e.name]=e.blob}),e.log("flash.XHR._send:",o,u,i),s.xhr={headers:{},abort:function(){y.cmd(o,"abort",u)},getResponseHeader:function(e){return this.headers[e]},getAllResponseHeaders:function(){return this.headers}};var a=e.queue(function(){y.cmd(o,"upload",{url:p(t.url),data:r,files:i,headers:t.headers,callback:c(function n(r){var i=r.type,o=r.result;e.log("flash.upload."+i+":",r);if("progress"==i)r.loaded=Math.min(r.loaded,r.total),r.lengthComputable=!0,t.progress(r);else if("complete"==i)h(n),"string"==typeof o&&(s.responseText=o.replace(/%22/g,'"').replace(/%5c/g,"\\").replace(/%26/g,"&").replace(/%25/g,"%")),s.end(r.status||200);else if("abort"==i||"error"==i)s.end(0,r.message),h(n)})})});e.each(i,function(t){a.inc(),e.getInfo(t,a.next)}),a.check()}})}};e.Flash=y;var b=new Image;e.event.one(b,"error load",function(){e.support.dataURI=1==b.width&&1==b.height,b=null,y.init()}),b.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="}}(FileAPI,window,document),"undefined"!=typeof ajs&&ajs.loaded&&ajs.loaded("{fileapi}FileAPI.min"),"function"==typeof define&&define.amd&&define("FileAPI",[],function(){return window.FileAPI||{}});