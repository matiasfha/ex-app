(function(){var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};define(["jquery","backbone","collections/resources","text!templates/resources/listado_items.js","text!templates/comentarios/_comentarios.js","models/comentario","text!templates/comentarios/comentario.js","views/visor","jquery.imagesloaded.min"],function($,Backbone,Resources,TListado,PComentarios,MComentario,TComentario,VisorView,I){var ItemView;return ItemView=function(_super){function ItemView(){return this.crearComentario=__bind(this.crearComentario,this),this.comentar=__bind(this.comentar,this),this.showMore=__bind(this.showMore,this),this.showVisor=__bind(this.showVisor,this),this.close=__bind(this.close,this),this.render=__bind(this.render,this),this.getSeccion=__bind(this.getSeccion,this),ItemView.__super__.constructor.apply(this,arguments)}return __extends(ItemView,_super),ItemView.prototype.el=$("#listado_container"),ItemView.prototype.events={"mouseenter .item":"showOverlay","mouseleave .item":"hideOverlay","click span.more":"showMore","click .social .comment":"comentar","click .social .like":"like","click img.comentar":"crearComentario","keydown input.text_comentario":"crearComentario","click .item .overlay:not(.social)":"showVisor"},ItemView.prototype.initialize=function(clasificacion){var _this=this;return this.clasificacion=clasificacion,this.tpl=eval(TListado),eval(PComentarios),this.tpl_comment=eval(TComentario),this.resources=new Resources,this.clasificacion!==!1?(this.getSeccion(),this.resources.url=""+this.resources.url+"/"+this.clasificacion+"/"+this.type,this.resources.fetch(),this.resources.on("reset",function(){return _this.render()})):this.render()},ItemView.prototype.getSeccion=function(){var e,t;e=$(".section.imagenes"),t=$(".section.videos"),this.type="todos";if(e.hasClass("active")&&!t.hasClass("active"))return this.type="imagen";if(!e.hasClass("active")&&t.hasClass("active"))return this.type="videos"},ItemView.prototype.render=function(){var e,t,n=this;if(this.clasificacion!==!1)return e=$(this.tpl(this.resources.toJSON()[0])),t=$(".item"),e.imagesLoaded(function(){return $(n.el).masonry("remove",t).masonry().html(e).masonry("reload")})},ItemView.prototype.close=function(){return $(this.el).undelegate()},ItemView.prototype.showVisor=function(e){var t;return t=$(e.currentTarget),new VisorView(t.closest(".item"))},ItemView.prototype.showOverlay=function(e){return $(e.currentTarget).find(".overlay").show(),!1},ItemView.prototype.hideOverlay=function(e){return $(e.currentTarget).find(".overlay").hide()},ItemView.prototype.like=function(e){var t,n,r,i;return i=$(e.currentTarget),r=i.closest(".item"),n=r.attr("id"),i.hasClass("active")?t="remove":t="add",$.post("/resources/like/"+n+"/"+t,function(e){return i.closest(".item").find(".like_count").text(e),i.toggleClass("active")})},ItemView.prototype.slideImageExtraInfo=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;a=e.nextAll(".item"),n=e.find(".comentarios"),s=[],r=e.find(".more");for(l=0,h=a.length;l<h;l++)u=a[l],$(u).css("left")===e.css("left")&&s.push(u);t=n.clone(),t.children().css({display:"block",visibility:"hidden"}),t.css({display:"block",visibility:"hidden"}).insertAfter(e.find(".comentarios")),o=t.height(),t.remove();for(c=0,p=s.length;c<p;c++)i=s[c],f=parseInt($(i).css("top")),r.hasClass("active")?($(i).attr("original-top",f),f=f+o+30):f=$(i).attr("original-top"),$(i).animate({top:f},300);return r.hasClass("active")?n.slideDown("fast"):n.slideUp("fast"),!1},ItemView.prototype.showMore=function(e){var t,n,r;return r=$(e.currentTarget),r.toggleClass("active"),n=r.closest(".item"),r.hasClass("active")?t='<img src="/assets/ver-.gif" />':t='<img src="/assets/ver+.gif" />',this.slideImageExtraInfo(n),$(e.currentTarget).html(t),!1},ItemView.prototype.comentar=function(e){var t,n,r;return r=$(e.currentTarget).closest(".item"),n=r.find(".more"),n.toggleClass("active"),n.hasClass("active")?t='<img src="/assets/ver-.gif" />':t='<img src="/assets/ver+.gif" />',this.slideImageExtraInfo(r),n.html(t),r.find(".text_comentario").focus(),!1},ItemView.prototype.crearComentario=function(e){var t,n,r,i,s,o,u=this;r=!1,e.type==="keydown"?e.which===13&&(r=!0,e.preventDefault()):e.type==="click"&&$(e.currentTarget).hasClass("comentar")&&(r=!0);if(r)return s=$(e.currentTarget).closest(".item"),o=s.attr("id"),i=$(e.currentTarget).closest(".new_comment"),n=i.find(".text_comentario").val(),t=new MComentario({contenido:n,resource_id:o}),t.save(),t.on("change",function(t){var n,r,o,a,f,l,c,h,p,d,v,m,g;a=$(u.tpl_comment(t.toJSON())),a.hide(),i.find(".text_comentario").val(""),n=s.find(".comment_count"),p=parseInt(n.html())+1,n.html(p),r=a.clone(),r.children().css({display:"block",visibility:"hidden"}),r.css({display:"block",visibility:"hidden"}).insertAfter(i),o=r.height(),r.remove(),$(u.el).height($(u.el).height()+o),c=parent.nextAll(".item"),f=[];for(d=0,m=c.length;d<m;d++)l=c[d],$(l).css("left")===s.css("left")&&f.push(l);for(v=0,g=f.length;v<g;v++)e=f[v],h=parseInt($(e).css("top")),flecha.hasClass("active")?h=$(e).attr("original-top"):($(e).attr("original-top",h),h=h+o+30),$(e).animate({top:h},300);return s.find(".nuevos_comentarios").append(a),a.fadeIn()})},ItemView}(Backbone.View)})}).call(this);